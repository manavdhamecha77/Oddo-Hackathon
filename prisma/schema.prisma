// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model Company {
  id          Int      @id @default(autoincrement())
  companyId   String   @unique @map("company_id") @db.VarChar(50)
  name        String   @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  invitations Invitation[]

  @@map("companies")
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)
  
  // Relations
  users       User[]
  invitations Invitation[]

  @@map("roles")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String?  @map("first_name") @db.VarChar(100)
  lastName     String?  @map("last_name") @db.VarChar(100)
  companyId    Int      @map("company_id")
  company      Company  @relation(fields: [companyId], references: [id])
  roleId       Int      @map("role_id")
  role         Role     @relation(fields: [roleId], references: [id])
  hourlyRate   Decimal  @default(0.00) @map("hourly_rate") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  managedProjects      Project[]          @relation("ProjectManager")
  projectMemberships   ProjectMember[]
  taskAssignments      TaskAssignment[]
  createdTasks         Task[]             @relation("CreatedBy")
  taskComments         TaskComment[]
  taskAttachments      TaskAttachment[]
  timesheets           Timesheet[]
  createdSalesOrders   SalesOrder[]       @relation("CreatedBy")
  createdPurchaseOrders PurchaseOrder[]   @relation("CreatedBy")
  createdInvoices      CustomerInvoice[]  @relation("CreatedBy")
  createdBills         VendorBill[]       @relation("CreatedBy")
  expenses             Expense[]          @relation("ExpenseUser")
  approvedExpenses     Expense[]          @relation("ApprovedBy")

  @@map("users")
}

model Invitation {
  id         Int              @id @default(autoincrement())
  email      String           @db.VarChar(255)
  token      String           @unique @default(cuid()) @db.VarChar(100)
  companyId  Int              @map("company_id")
  company    Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  roleId     Int              @map("role_id")
  role       Role             @relation(fields: [roleId], references: [id])
  status     InvitationStatus @default(pending)
  invitedBy  Int?             @map("invited_by")
  expiresAt  DateTime         @map("expires_at")
  acceptedAt DateTime?        @map("accepted_at")
  createdAt  DateTime         @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@map("invitations")
}

enum InvitationStatus {
  pending
  accepted
  expired
  cancelled

  @@map("invitation_status")
}

// ============================================
// PARTNERS (CUSTOMERS & VENDORS)
// ============================================

model Partner {
  id        Int         @id @default(autoincrement())
  name      String      @db.VarChar(255)
  type      PartnerType
  email     String?     @db.VarChar(255)
  phone     String?     @db.VarChar(50)
  address   String?
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  projectsAsCustomer Project[]         @relation("Customer")
  salesOrders        SalesOrder[]
  customerInvoices   CustomerInvoice[]
  purchaseOrders     PurchaseOrder[]
  vendorBills        VendorBill[]

  @@map("partners")
}

enum PartnerType {
  customer
  vendor
  both

  @@map("partner_type")
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  costPrice   Decimal? @map("cost_price") @db.Decimal(10, 2)
  isService   Boolean  @default(false) @map("is_service")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  salesOrderLines      SalesOrderLine[]
  purchaseOrderLines   PurchaseOrderLine[]
  customerInvoiceLines CustomerInvoiceLine[]
  vendorBillLines      VendorBillLine[]

  @@map("products")
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id                Int            @id @default(autoincrement())
  name              String         @db.VarChar(255)
  description       String?
  projectManagerId  Int?           @map("project_manager_id")
  customerId        Int?           @map("customer_id")
  status            ProjectStatus  @default(planned)
  startDate         DateTime?      @map("start_date") @db.Date
  endDate           DateTime?      @map("end_date") @db.Date
  deadline          DateTime?      @db.Date
  budget            Decimal        @default(0.00) @db.Decimal(12, 2)
  progress          Decimal        @default(0.00) @db.Decimal(5, 2)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  // Relations
  projectManager   User?             @relation("ProjectManager", fields: [projectManagerId], references: [id], onDelete: SetNull)
  customer         Partner?          @relation("Customer", fields: [customerId], references: [id], onDelete: SetNull)
  members          ProjectMember[]
  tasks            Task[]
  timesheets       Timesheet[]
  salesOrders      SalesOrder[]
  purchaseOrders   PurchaseOrder[]
  customerInvoices CustomerInvoice[]
  vendorBills      VendorBill[]
  expenses         Expense[]

  @@index([status])
  @@index([projectManagerId])
  @@map("projects")
}

enum ProjectStatus {
  planned
  in_progress
  completed
  on_hold

  @@map("project_status")
}

// ============================================
// PROJECT TEAM MEMBERS
// ============================================

model ProjectMember {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  userId     Int      @map("user_id")
  role       String?  @db.VarChar(100)
  assignedAt DateTime @default(now()) @map("assigned_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

// ============================================
// TASKS
// ============================================

model Task {
  id             Int         @id @default(autoincrement())
  projectId      Int         @map("project_id")
  title          String      @db.VarChar(255)
  description    String?
  status         TaskStatus  @default(new)
  priority       TaskPriority @default(medium)
  dueDate        DateTime?   @map("due_date") @db.Date
  estimatedHours Decimal?    @map("estimated_hours") @db.Decimal(8, 2)
  actualHours    Decimal     @default(0.00) @map("actual_hours") @db.Decimal(8, 2)
  blockerReason  String?     @map("blocker_reason")
  createdBy      Int?        @map("created_by")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator     User?            @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  assignees   TaskAssignment[]
  comments    TaskComment[]
  attachments TaskAttachment[]
  timesheets  Timesheet[]

  @@index([projectId])
  @@index([status])
  @@map("tasks")
}

enum TaskStatus {
  new
  in_progress
  blocked
  done

  @@map("task_status")
}

enum TaskPriority {
  low
  medium
  high
  urgent

  @@map("task_priority")
}

// ============================================
// TASK ASSIGNMENTS (Many-to-Many)
// ============================================

model TaskAssignment {
  id         Int      @id @default(autoincrement())
  taskId     Int      @map("task_id")
  userId     Int      @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy Int?     @map("assigned_by")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignments")
}

// ============================================
// TASK COMMENTS
// ============================================

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  comment   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

// ============================================
// TASK ATTACHMENTS
// ============================================

model TaskAttachment {
  id         Int      @id @default(autoincrement())
  taskId     Int      @map("task_id")
  fileName   String   @map("file_name") @db.VarChar(255)
  filePath   String   @map("file_path") @db.VarChar(500)
  fileSize   Int?     @map("file_size")
  uploadedBy Int?     @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  task     Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader User? @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@map("task_attachments")
}

// ============================================
// TIMESHEETS
// ============================================

model Timesheet {
  id          Int      @id @default(autoincrement())
  taskId      Int      @map("task_id")
  userId      Int      @map("user_id")
  projectId   Int      @map("project_id")
  workDate    DateTime @map("work_date") @db.Date
  hours       Decimal  @db.Decimal(8, 2)
  isBillable  Boolean  @default(true) @map("is_billable")
  isBilled    Boolean  @default(false) @map("is_billed")
  hourlyRate  Decimal  @map("hourly_rate") @db.Decimal(10, 2)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  task    Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([workDate])
  @@map("timesheets")
}

// ============================================
// SALES ORDERS
// ============================================

model SalesOrder {
  id           Int              @id @default(autoincrement())
  orderNumber  String           @unique @map("order_number") @db.VarChar(100)
  projectId    Int?             @map("project_id")
  customerId   Int              @map("customer_id")
  orderDate    DateTime         @default(now()) @map("order_date") @db.Date
  status       SalesOrderStatus @default(draft)
  totalAmount  Decimal          @default(0.00) @map("total_amount") @db.Decimal(12, 2)
  notes        String?
  createdBy    Int?             @map("created_by")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  project         Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  customer        Partner             @relation(fields: [customerId], references: [id], onDelete: Restrict)
  creator         User?               @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  lines           SalesOrderLine[]
  customerInvoices CustomerInvoice[]

  @@index([projectId])
  @@map("sales_orders")
}

enum SalesOrderStatus {
  draft
  confirmed
  done
  cancelled

  @@map("sales_order_status")
}

model SalesOrderLine {
  id            Int     @id @default(autoincrement())
  salesOrderId  Int     @map("sales_order_id")
  productId     Int?    @map("product_id")
  description   String
  quantity      Decimal @default(1) @db.Decimal(10, 2)
  unitPrice     Decimal @map("unit_price") @db.Decimal(10, 2)

  // Relations
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product?   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("sales_order_lines")
}

// ============================================
// PURCHASE ORDERS
// ============================================

model PurchaseOrder {
  id           Int                 @id @default(autoincrement())
  orderNumber  String              @unique @map("order_number") @db.VarChar(100)
  projectId    Int?                @map("project_id")
  vendorId     Int                 @map("vendor_id")
  orderDate    DateTime            @default(now()) @map("order_date") @db.Date
  status       PurchaseOrderStatus @default(draft)
  totalAmount  Decimal             @default(0.00) @map("total_amount") @db.Decimal(12, 2)
  notes        String?
  createdBy    Int?                @map("created_by")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  // Relations
  project     Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  vendor      Partner             @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  creator     User?               @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  lines       PurchaseOrderLine[]
  vendorBills VendorBill[]

  @@index([projectId])
  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  draft
  sent
  received
  cancelled

  @@map("purchase_order_status")
}

model PurchaseOrderLine {
  id              Int     @id @default(autoincrement())
  purchaseOrderId Int     @map("purchase_order_id")
  productId       Int?    @map("product_id")
  description     String
  quantity        Decimal @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal @map("unit_price") @db.Decimal(10, 2)

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product?      @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("purchase_order_lines")
}

// ============================================
// CUSTOMER INVOICES
// ============================================

model CustomerInvoice {
  id            Int                   @id @default(autoincrement())
  invoiceNumber String                @unique @map("invoice_number") @db.VarChar(100)
  projectId     Int?                  @map("project_id")
  salesOrderId  Int?                  @map("sales_order_id")
  customerId    Int                   @map("customer_id")
  invoiceDate   DateTime              @default(now()) @map("invoice_date") @db.Date
  dueDate       DateTime?             @map("due_date") @db.Date
  status        CustomerInvoiceStatus @default(draft)
  totalAmount   Decimal               @default(0.00) @map("total_amount") @db.Decimal(12, 2)
  paidAmount    Decimal               @default(0.00) @map("paid_amount") @db.Decimal(12, 2)
  notes         String?
  createdBy     Int?                  @map("created_by")
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")

  // Relations
  project    Project?              @relation(fields: [projectId], references: [id], onDelete: SetNull)
  salesOrder SalesOrder?           @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)
  customer   Partner               @relation(fields: [customerId], references: [id], onDelete: Restrict)
  creator    User?                 @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  lines      CustomerInvoiceLine[]

  @@index([projectId])
  @@map("customer_invoices")
}

enum CustomerInvoiceStatus {
  draft
  sent
  paid
  cancelled

  @@map("customer_invoice_status")
}

model CustomerInvoiceLine {
  id          Int     @id @default(autoincrement())
  invoiceId   Int     @map("invoice_id")
  productId   Int?    @map("product_id")
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)

  // Relations
  invoice CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("customer_invoice_lines")
}

// ============================================
// VENDOR BILLS
// ============================================

model VendorBill {
  id               Int              @id @default(autoincrement())
  billNumber       String           @unique @map("bill_number") @db.VarChar(100)
  projectId        Int?             @map("project_id")
  purchaseOrderId  Int?             @map("purchase_order_id")
  vendorId         Int              @map("vendor_id")
  billDate         DateTime         @default(now()) @map("bill_date") @db.Date
  dueDate          DateTime?        @map("due_date") @db.Date
  status           VendorBillStatus @default(draft)
  totalAmount      Decimal          @default(0.00) @map("total_amount") @db.Decimal(12, 2)
  paidAmount       Decimal          @default(0.00) @map("paid_amount") @db.Decimal(12, 2)
  notes            String?
  createdBy        Int?             @map("created_by")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  project       Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  purchaseOrder PurchaseOrder?    @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  vendor        Partner           @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  creator       User?             @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  lines         VendorBillLine[]

  @@index([projectId])
  @@map("vendor_bills")
}

enum VendorBillStatus {
  draft
  posted
  paid
  cancelled

  @@map("vendor_bill_status")
}

model VendorBillLine {
  id          Int     @id @default(autoincrement())
  billId      Int     @map("bill_id")
  productId   Int?    @map("product_id")
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)

  // Relations
  bill    VendorBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  product Product?   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("vendor_bill_lines")
}

// ============================================
// EXPENSES
// ============================================

model Expense {
  id            Int           @id @default(autoincrement())
  expenseNumber String        @unique @map("expense_number") @db.VarChar(100)
  projectId     Int?          @map("project_id")
  userId        Int           @map("user_id")
  category      String        @db.VarChar(100)
  description   String
  amount        Decimal       @db.Decimal(10, 2)
  expenseDate   DateTime      @default(now()) @map("expense_date") @db.Date
  isBillable    Boolean       @default(false) @map("is_billable")
  isBilled      Boolean       @default(false) @map("is_billed")
  status        ExpenseStatus @default(submitted)
  receiptPath   String?       @map("receipt_path") @db.VarChar(500)
  approvedBy    Int?          @map("approved_by")
  approvedAt    DateTime?     @map("approved_at")
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user     User     @relation("ExpenseUser", fields: [userId], references: [id], onDelete: Restrict)
  approver User?    @relation("ApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([userId])
  @@map("expenses")
}

enum ExpenseStatus {
  submitted
  approved
  rejected
  reimbursed

  @@map("expense_status")
}
